# F5 BIG-IP iRule Profiler

This repo contains a python script that provides useful data based on the logs generated by BIG-IP's rule profiler.

Prior to using this tool, it is very useful to review the following devcentral articles on iRule performance profiling:

[iRule Execution Tracing & Performance Profiling Part 1](https://community.f5.com/t5/technical-articles/irule-execution-tracing-and-performance-profiling-part-1/ta-p/276368)

[iRule Execution Tracing & Performance Profiling Part 3](https://community.f5.com/t5/technical-articles/irule-execution-tracing-and-performance-profiling-part-2/ta-p/276364)

[iRule Execution Tracing & Performance Profiling Part 3](https://community.f5.com/t5/technical-articles/irule-execution-tracing-and-performance-profiling-part-3/ta-p/276362)

# Commands to generate performance log data:
1. Create Log Publisher, ideally this should go off-box, but you can use a local log publisher in non-prod:
    ```
    tmsh create sys log-config publisher local-log-publisher { destinations 
    replace-all-with { local-syslog { } } }
    ```
2. Create the rule-profiler:
    ```
    tmsh create ltm rule-profiler demo-profiler publisher local-log-publisher period 60000 event-filter replace-all-with { CLIENT_ACCEPTED HTTP_REQUEST HTTP_REQUEST_DATA } occ-mask { cmd cmd-vm rule event rule-vm } vs-filter replace-all-with { /Common/my-virtualserver-name } rule-filter replace-all-with { /Common/my-irule-name }
    ```
3. Enable the rule-profiler:
    ```
    tmsh modify ltm rule-profiler demo-profiler state enabled
    ```
4. Start the rule-profiler, with traffic running, note it will only run for the duration of time defined in period:
    ```
    tmsh start ltm rule-profiler demo-profiler
    ```
5. Stop the rule-profiler
    ```
    tmsh stop ltm rule-profiler demo-profiler
    ```


# Analysis script

The script should be able to run on a BIG-IP, it is currently hard coded to look for logs in /var/log/ltm.  This can easily be changed, and likely should be changed if you're doing extensive analysis.

Copy the script up to the big-ip in /var/tmp and use python to run it.

The following is an example of the output the script gives you:
```
$ python /var/tmp/rule-profiler-parser.py
========================================
============== Event Data ==============
========================================
COMMAND VM: HTTP_REQUEST        Count: 598
        Total Time: 2328ms
        Mean Execution Time:    3894us
        Standard Deviation:     5060.92
        Max Execution Time:     20363
        Min Execution Time:     27
========================================
COMMAND VM: CLIENT_ACCEPTED     Count: 1010
        Total Time: 5395ms
        Mean Execution Time:    5341us
        Standard Deviation:     6484.85
        Max Execution Time:     30375
        Min Execution Time:     23
========================================


========================================
============= Command Data =============
========================================
COMMAND VM: IP::addr    Count: 664
        Total Time: 27ms
        Mean Execution Time:    40us
        Standard Deviation:     588.53
        Max Execution Time:     11509
        Min Execution Time:     1
========================================
COMMAND VM: IP::local_addr      Count: 393
        Total Time: 195ms
        Mean Execution Time:    496us
        Standard Deviation:     4340.02
        Max Execution Time:     41914
        Min Execution Time:     1
========================================
COMMAND VM: b64encode   Count: 284
        Total Time: 2ms
        Mean Execution Time:    7us
        Standard Deviation:     7.48
        Max Execution Time:     81
        Min Execution Time:     1
========================================
COMMAND VM: HTTP::respond       Count: 169
        Total Time: 1ms
        Mean Execution Time:    11us
        Standard Deviation:     9.27
        Max Execution Time:     48
        Min Execution Time:     2
========================================
COMMAND VM: virtual     Count: 1237
        Total Time: 420ms
        Mean Execution Time:    339us
        Standard Deviation:     2934.28
        Max Execution Time:     40332
        Min Execution Time:     1
========================================
COMMAND VM: LB::server  Count: 213
        Total Time: 1ms
        Mean Execution Time:    7us
        Standard Deviation:     7.81
        Max Execution Time:     79
        Min Execution Time:     1
========================================
COMMAND VM: HTTP::path  Count: 211
        Total Time: 57ms
        Mean Execution Time:    272us
        Standard Deviation:     1560.45
        Max Execution Time:     9881
        Min Execution Time:     2
========================================
COMMAND VM: URI::basename       Count: 678
        Total Time: 185ms
        Mean Execution Time:    273us
        Standard Deviation:     2233.23
        Max Execution Time:     30168
        Min Execution Time:     1
========================================
COMMAND VM: IP::client_addr     Count: 647
        Total Time: 95ms
        Mean Execution Time:    147us
        Standard Deviation:     1716.12
        Max Execution Time:     30189
        Min Execution Time:     1
========================================
COMMAND VM: table       Count: 3250
        Total Time: 806ms
        Mean Execution Time:    248us
        Standard Deviation:     1663.17
        Max Execution Time:     20560
        Min Execution Time:     1
========================================
COMMAND VM: class       Count: 2293
        Total Time: 95ms
        Mean Execution Time:    41us
        Standard Deviation:     568.23
        Max Execution Time:     9997
        Min Execution Time:     1
========================================
COMMAND VM: URI::path   Count: 470
        Total Time: 251ms
        Mean Execution Time:    534us
        Standard Deviation:     3248.51
        Max Execution Time:     29943
        Min Execution Time:     1
========================================


========================================
=========== Command VM Data ============
========================================
COMMAND VM: info        Count: 635
        Total Time: 318ms
        Mean Execution Time:    501us
        Standard Deviation:     3178.17
        Max Execution Time:     29662
        Min Execution Time:     1
========================================
COMMAND VM: IP::addr    Count: 650
        Total Time: 100ms
        Mean Execution Time:    155us
        Standard Deviation:     1127.79
        Max Execution Time:     11337
        Min Execution Time:     5
========================================
COMMAND VM: IP::local_addr      Count: 385
        Total Time: 446ms
        Mean Execution Time:    1159us
        Standard Deviation:     6531.25
        Max Execution Time:     40182
        Min Execution Time:     5
========================================
COMMAND VM: string      Count: 1116
        Total Time: 268ms
        Mean Execution Time:    240us
        Standard Deviation:     2387.34
        Max Execution Time:     30025
        Min Execution Time:     1
========================================
COMMAND VM: b64encode   Count: 273
        Total Time: 91ms
        Mean Execution Time:    335us
        Standard Deviation:     1703.57
        Max Execution Time:     9812
        Min Execution Time:     5
========================================
COMMAND VM: HTTP::respond       Count: 132
        Total Time: 222ms
        Mean Execution Time:    1687us
        Standard Deviation:     3634.8
        Max Execution Time:     10264
        Min Execution Time:     6
========================================
COMMAND VM: virtual     Count: 1263
        Total Time: 1684ms
        Mean Execution Time:    1333us
        Standard Deviation:     5194.7
        Max Execution Time:     40314
        Min Execution Time:     5
========================================
COMMAND VM: return      Count: 166
        Total Time: 1ms
        Mean Execution Time:    6us
        Standard Deviation:     3.32
        Max Execution Time:     33
        Min Execution Time:     2
========================================
COMMAND VM: LB::server  Count: 205
        Total Time: 42ms
        Mean Execution Time:    208us
        Standard Deviation:     1337.23
        Max Execution Time:     9880
        Min Execution Time:     5
========================================
COMMAND VM: switch      Count: 101
        Total Time: 431ms
        Mean Execution Time:    4272us
        Standard Deviation:     4721.57
        Max Execution Time:     10459
        Min Execution Time:     59
========================================
COMMAND VM: HTTP::path  Count: 209
        Total Time: 60ms
        Mean Execution Time:    288us
        Standard Deviation:     1571.1
        Max Execution Time:     9893
        Min Execution Time:     5
========================================
COMMAND VM: call        Count: 661
        Total Time: 1689ms
        Mean Execution Time:    2556us
        Standard Deviation:     4189.46
        Max Execution Time:     10330
        Min Execution Time:     12
========================================
COMMAND VM: URI::basename       Count: 654
        Total Time: 312ms
        Mean Execution Time:    478us
        Standard Deviation:     2437.37
        Max Execution Time:     20796
        Min Execution Time:     5
========================================
COMMAND VM: IP::client_addr     Count: 576
        Total Time: 443ms
        Mean Execution Time:    770us
        Standard Deviation:     3165.84
        Max Execution Time:     30034
        Min Execution Time:     5
========================================
COMMAND VM: table       Count: 3232
        Total Time: 2391ms
        Mean Execution Time:    739us
        Standard Deviation:     2909.38
        Max Execution Time:     30057
        Min Execution Time:     5
========================================
COMMAND VM: class       Count: 2255
        Total Time: 263ms
        Mean Execution Time:    117us
        Standard Deviation:     947.76
        Max Execution Time:     10269
        Min Execution Time:     5
========================================
COMMAND VM: URI::path   Count: 449
        Total Time: 246ms
        Mean Execution Time:    549us
        Standard Deviation:     3139.69
        Max Execution Time:     29316
        Min Execution Time:     5
========================================
COMMAND VM: split       Count: 563
        Total Time: 63ms
        Mean Execution Time:    112us
        Standard Deviation:     1305.06
        Max Execution Time:     20102
        Min Execution Time:     1
========================================
```